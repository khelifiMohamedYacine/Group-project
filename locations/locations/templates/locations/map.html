<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Locations</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/maplibre-gl/dist/maplibre-gl.css"
    />
    <style>
      #map {
        height: 800px;
        width: 90%;
        margin: 20px auto;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }
    </style>
  </head>
  <body>
    <div class="container mt-4 mb-4 d-flex justify-content-center w-75">
      <div class="w-75">
        <div class="row g-4">
          <!--Address and Location Name-->
          <div class="col-md-6">
            <div class="form-floating">
              <input
                type="text"
                class="form-control"
                id="floatingAddress"
                placeholder="Enter address"
                readonly
              />
              <label for="floatingAddress">Address</label>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-floating">
              <input
                type="text"
                class="form-control"
                id="floatingLocationName"
                placeholder="Enter location name"
              />
              <label for="floatingLocationName">Enter Location Name</label>
            </div>
          </div>
        </div>
        <div class="row g-4 mt-2">
          <!--Postcode and State-->
          <div class="col-md-6">
            <div class="form-floating">
              <input
                type="text"
                class="form-control"
                id="floatingPostcode"
                placeholder="Enter postcode"
              />
              <label for="floatingPostcode">Enter Postcode</label>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-floating">
              <textarea
                class="form-control"
                placeholder="United Kingdom"
                id="floatingTextarea2Disabled"
                style="height: 58px"
                disabled
              >
                United Kingdom</textarea
              >
              <label for="floatingTextarea2Disabled">State</label>
            </div>
          </div>
        </div>
        <div class="row g-4 mt-2" id="taskContainer">
          <!--Tasks-->
          <div class="col-md-6">
            <div class="input-group">
              <span class="input-group-text">Task 1</span>
              <input
                type="text"
                class="form-control task-input"
                placeholder="Enter task"
              />
              <span
                class="input-group-text addTaskBtn"
                style="
                  cursor: pointer;
                  color: grey;
                  background: none;
                  border-left: none;
                "
                >+</span
              >
            </div>
          </div>
        </div>
      </div>
    </div>
    <!--Add Location Button-->
    <div class="row g-4 mt-2">
      <div class="col-md-12 text-center">
        <button type="button" class="btn btn-primary" id="addLocationBtn">
          Add Location
        </button>
      </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/maplibre-gl/dist/maplibre-gl.js"></script>
    <script>
      //The Map:
      let marker = null;
      var map = new maplibregl.Map({
        container: "map",
        style: "https://tiles.openfreemap.org/styles/bright",
        center: [-3.5351, 50.7371],
        zoom: 14,
      });

      //Getting the saved locations in Database on a json file, use http://127.0.0.1:8000/locations/get-locations/
      document.addEventListener("DOMContentLoaded", async function () {
        try {
          let response = await fetch("/locations/get-locations/");
          let data = await response.json(); // Parse JSON
          console.log("Fetched data:", data);

          if (!Array.isArray(data)) {
            console.error("Expected an array, but got:", data);
            return;
          }

          //Add markers of stored locations everytime page loads
          data.forEach((location) => {
            new maplibregl.Marker()
              .setLngLat([location.longitude, location.latitude])
              .setPopup(new maplibregl.Popup().setText(location.location_name))
              .addTo(map);
          });
        } catch (error) {
          console.error("Error loading saved locations:", error);
        }
      });

      let selectedCoordinates = null;
      document
        .getElementById("floatingPostcode")
        .addEventListener("input", async function () {
          //Auto-fill the Address bar after the user enters the postcode
          let postcode = this.value.trim();
          if (postcode.length >= 5) {
            try {
              let response = await fetch(
                `https://api.postcodes.io/postcodes/${postcode}`
              );
              let data = await response.json();
              if (data.status === 200) {
                let result = data.result;
                let fullAddress = [
                  result.thoroughfare,
                  result.street,
                  result.dependent_thoroughfare,
                  result.admin_district,
                  result.post_town,
                  result.region,
                  result.country,
                ]
                  .filter(Boolean)
                  .join(", ");
                document.getElementById("floatingAddress").value =
                  fullAddress || "Unknown Address";
                selectedCoordinates = {
                  lat: result.latitude,
                  lon: result.longitude,
                };
                map.flyTo({
                  //Fly to the location after the user enters the postcode
                  center: [selectedCoordinates.lon, selectedCoordinates.lat],
                  zoom: 12,
                });
              } /*else {
                console.warn("Invalid postcode");
              } */
            } catch (error) {
              console.error("Error fetching postcode data:", error);
            }
          }
        });

      let lastMarker = null;
      document.addEventListener("DOMContentLoaded", function () {
        // Listen for map click to get coordinates and auto-fill address
        map.on("click", async function (e) {
          const clickedLngLat = e.lngLat; // Get the clicked coordinates

          // Remove the last marker if it exists
          if (lastMarker) {
            lastMarker.remove();
          }

          // Fetch the nearest postcode from the coordinates using Postcodes.io
          try {
            const response = await fetch(
              `https://api.postcodes.io/postcodes?lat=${clickedLngLat.lat}&lon=${clickedLngLat.lng}`
            );
            const data = await response.json();

            // Add the marker directly using the clicked coordinates
            lastMarker = new maplibregl.Marker({ color: "red" })
              .setLngLat([clickedLngLat.lng, clickedLngLat.lat])
              .addTo(map);

            if (data.result && data.result.length > 0) {
              const postcode = data.result[0].postcode; // Get the postcode from the result

              // Now use the postcode to get the full address
              const addressResponse = await fetch(
                `https://api.postcodes.io/postcodes/${postcode}`
              );
              const addressData = await addressResponse.json();

              if (addressData.result) {
                const result = addressData.result;

                // Build the address string by checking the availability of address components
                const line1 = result.line_1 || "";
                const line2 = result.line_2 ? `${result.line_2}, ` : ""; // Add comma if line_2 is available
                const city = result.city || "";
                const county = result.county || "";
                const country = result.country || "";

                const fullAddress =
                  `${line1} ${line2}${city} ${county} ${country}`
                    .trim()
                    .replace(/, +$/, ""); // Remove any trailing comma

                // Auto-fill the fields with the retrieved address and postcode
                document.getElementById("floatingAddress").value = fullAddress;
                document.getElementById("floatingPostcode").value = postcode;

                // Save the coordinates for later when the user adds the location
                selectedCoordinates = {
                  lat: clickedLngLat.lat,
                  lon: clickedLngLat.lng,
                };
              } else {
                alert("Address not found for the selected postcode.");
              }
            } else {
              // If postcode is not found, still add the marker using the clicked coordinates
              selectedCoordinates = {
                lat: clickedLngLat.lat,
                lon: clickedLngLat.lng,
              };
              // Instead of leaving it empty, assign "Not Available" to the postcode field
              document.getElementById("floatingPostcode").value =
                "Not Available";
              document.getElementById("floatingAddress").value =
                "Address not available"; // Optional fallback
            }
          } catch (error) {
            console.error("Error fetching address:", error);
            alert("Failed to retrieve address for the selected location.");
            // If error occurs, set postcode as 'Not Available'
            document.getElementById("floatingPostcode").value = "Not Available";
          }
        });

        //Add marker when the user presses the button. Already saved locations will be in blue, new ones added will be in red
        document
          .getElementById("addLocationBtn")
          .addEventListener("click", async function () {
            let postcode = document
              .getElementById("floatingPostcode")
              .value.trim();
            let address = document
              .getElementById("floatingAddress")
              .value.trim();
            let locationName = document
              .getElementById("floatingLocationName")
              .value.trim();
            if (!postcode || !address || !locationName) {
              alert("Please fill in all fields before adding the location.");
              return;
            }

            if (selectedCoordinates) {
              let response = await fetch("/locations/add-location/", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  "X-CSRFToken": getCSRFToken(),
                },
                body: JSON.stringify({
                  postcode: postcode,
                  address: address,
                  location_name: locationName,
                  latitude: selectedCoordinates.lat,
                  longitude: selectedCoordinates.lon,
                }),
              });

              let result = await response.json();

              if (response.ok) {
                // Only add the marker if the response is successful
                new maplibregl.Marker({ color: "red" })
                  .setLngLat([selectedCoordinates.lon, selectedCoordinates.lat])
                  .addTo(map);

                alert("Location added successfully!");
              } else if (
                response.status === 400 &&
                result.error ===
                  "Location with these coordinates already exists"
              ) {
                alert("This location already exists with these coordinates.");
              } else {
                alert("An error occurred while adding the location.");
              }
            } else {
              alert("Please enter a valid postcode to get coordinates.");
            }
          });
      });
      //To keep track of the tasks and allows the users to add any number of tasks
      document.addEventListener("DOMContentLoaded", function () {
        let taskCount = 1; // Keeps track of the number of tasks
        const maxTasks = 2; // Maximum number of tasks allowed

        // Disable add task button if taskCount reaches maxTasks
        const addTaskButton = document.querySelector(".addTaskBtn");

        addTaskButton.addEventListener("click", function () {
          // Check if the maximum task limit has been reached
          if (taskCount >= maxTasks) {
            alert("You can only add a maximum of 2 tasks.");
            return;
          }

          taskCount++;
          let taskContainer = document.getElementById("taskContainer");

          // Create new task row
          let newTaskRow = document.createElement("div");
          newTaskRow.className = "row g-4 mt-2";
          newTaskRow.innerHTML = `
      <div class="col-md-6">
        <div class="input-group">
          <span class="input-group-text">Task ${taskCount}</span>
          <input
            type="text"
            class="form-control task-input"
            placeholder="Enter task"
          />
          <span
            class="input-group-text removeTaskBtn"
            style="cursor: pointer; color: grey; background: none; border-left: none;"
          >
            -
          </span>
        </div>
      </div>
    `;

          taskContainer.appendChild(newTaskRow);

          // Remove task field when clicking "-"
          newTaskRow
            .querySelector(".removeTaskBtn")
            .addEventListener("click", function () {
              newTaskRow.remove();
              taskCount--;
              updateTaskNumbers();
            });
        });

        // Function to renumber tasks after removing one
        function updateTaskNumbers() {
          let taskLabels = document.querySelectorAll(
            "#taskContainer .input-group-text:first-child"
          );
          taskCount = 0;
          taskLabels.forEach((label) => {
            taskCount++;
            label.textContent = `Task ${taskCount}`;
          });

          // If task count is less than maxTasks, enable the add button
          const addTaskButton = document.querySelector(".addTaskBtn");
          if (taskCount < maxTasks) {
            addTaskButton.disabled = false;
          }
        }
      });
    </script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
